{% assign max_items = page.sidebar_limit | default: 4 %}
{% assign per_page = 2 %}

{% assign toc_enabled = true %}
{% if page.toc == false %}
  {% assign toc_enabled = false %}
{% endif %}

{% assign total_posts = site.posts | size %}
{% assign render_count = total_posts %}
{% if render_count > max_items %}
  {% assign render_count = max_items %}
{% endif %}

{% assign show_tags = false %}
{% if page.url == "/" or page.sidebar_show_tags == true %}
  {% assign show_tags = true %}
{% endif %}

<div class="rf-side-stack">
  {% if toc_enabled and page.layout == "post" %}
    {% include rf/toc.html %}
  {% endif %}

  <section class="rf-rail rf-rail--latest">
    <div class="rf-rail-head">
      <div class="rf-rail-kicker">{{ site.sidebar_kicker | default: "LATEST" }}</div>
      <h2 class="rf-rail-title">{{ site.sidebar_title | default: "Recent Posts" }}</h2>
    </div>

    <div
      class="rf-rail-pages"
      data-per-page="{{ per_page }}"
      data-total="{{ render_count }}"
    >
      {% for post in site.posts limit:render_count %}
        <article class="rf-card rf-card--post rf-rail-item" data-idx="{{ forloop.index0 }}">
          <header class="rf-card-head">
            <h3 class="rf-card-title">
              <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
            </h3>

            <div class="rf-meta">
              <time datetime="{{ post.date | date_to_xmlschema }}">
                {{ post.date | date: "%b %-d, %Y" }}
              </time>

              {% if post.categories and post.categories.size > 0 %}
                <span class="rf-dot">â€¢</span>
                <span class="rf-cat">{{ post.categories[0] }}</span>
              {% endif %}
            </div>
          </header>

          <div class="rf-card-body rf-card-body--post">
            {% assign blurb = post.description | default: post.excerpt %}
            <p class="rf-excerpt">
              {{ blurb | strip_html | strip_newlines | truncate: 140 }}
            </p>
          </div>

          <div class="rf-pricebar">
            <div class="rf-price">READ</div>
            <a class="rf-arrow" href="{{ post.url | relative_url }}" aria-label="Read post"></a>
          </div>
        </article>
      {% endfor %}
    </div>

    {% if render_count > per_page %}
      <nav class="rf-rail-pager" aria-label="Recent posts pagination">
        <button class="rf-pager-btn rf-pager-prev" type="button" aria-label="Previous posts" disabled>Prev</button>
        <span class="rf-pager-status" aria-live="polite">1 / 1</span>
        <button class="rf-pager-btn rf-pager-next" type="button" aria-label="Next posts">Next</button>
      </nav>
    {% endif %}

    {% if site.posts.size > max_items %}
      <div class="rf-rail-more">
        <a class="rf-morelink" href="{{ '/blog/' | relative_url }}">View all posts</a>
      </div>
    {% endif %}
  </section>

  {% if show_tags %}
    <section class="rf-rail rf-rail--tags">
      <div class="rf-rail-head">
        <div class="rf-rail-kicker">BROWSE</div>
        <h2 class="rf-rail-title">Tags</h2>
      </div>

      <div class="rf-rail-body">
        {% include rf/tag-cloud.html %}
      </div>
    </section>
  {% endif %}
</div>

<script>
(() => {
  const root = document.currentScript?.previousElementSibling?.querySelector?.(".rf-rail-pages")
            || document.querySelector(".rf-rail-pages");
  if (!root) return;

  const total = +root.dataset.total || 0;
  const perPage = +root.dataset.perPage || 2;
  if (total <= perPage) return;

  const items = [...root.querySelectorAll(".rf-rail-item")];
  const pager = root.parentElement.querySelector(".rf-rail-pager");
  if (!pager) return;

  const prevBtn = pager.querySelector(".rf-pager-prev");
  const nextBtn = pager.querySelector(".rf-pager-next");
  const status = pager.querySelector(".rf-pager-status");

  const pages = Math.max(1, Math.ceil(total / perPage));
  let page = 0;

  const render = () => {
    const start = page * perPage;
    const end = start + perPage;

    for (let i = 0; i < items.length; i++) {
      items[i].hidden = !(i >= start && i < end);
    }

    status.textContent = `${page + 1} / ${pages}`;
    prevBtn.disabled = page <= 0;
    nextBtn.disabled = page >= pages - 1;
  };

  prevBtn.addEventListener("click", () => { if (page > 0) { page--; render(); } });
  nextBtn.addEventListener("click", () => { if (page < pages - 1) { page++; render(); } });

  render();
})();
</script>
