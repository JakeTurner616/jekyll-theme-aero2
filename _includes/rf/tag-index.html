{%- comment -%}
Tag index across posts + pages (no plugins)
- Each tag group gets data-tag + data-slug for filtering
{%- endcomment -%}

{%- assign all_tags = "" -%}

{%- for post in site.posts -%}
  {%- if post.tags -%}
    {%- for t in post.tags -%}{%- assign all_tags = all_tags | append: t | append: "|" -%}{%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- for p in site.pages -%}
  {%- if p.tags -%}
    {%- for t in p.tags -%}{%- assign all_tags = all_tags | append: t | append: "|" -%}{%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- assign raw = all_tags | split: "|" -%}

{%- assign clean = "" -%}
{%- for t in raw -%}
  {%- assign s = t | strip -%}
  {%- if s != "" -%}{%- assign clean = clean | append: s | append: "|" -%}{%- endif -%}
{%- endfor -%}

{%- assign tags = clean | split: "|" -%}
{%- assign uniq = tags | sort | uniq -%}

<div class="rf-tagindex">
  {%- for tag in uniq -%}
    {%- assign slug = tag | downcase | strip
      | replace: " ", "-"
      | replace: ".", ""
      | replace: ",", ""
      | replace: "/", "-"
    -%}

    <section
      class="rf-taggroup"
      id="tag-{{ slug }}"
      data-tag="{{ tag | escape }}"
      data-slug="{{ slug | escape }}"
    >
      <header class="rf-taggroup-head">
        <h2 class="rf-h2">{{ tag }}</h2>
        <a class="rf-taggroup-top" href="#top">Back to top</a>
      </header>

      {%- assign pages_found = 0 -%}
      {%- capture pages_list -%}
        {%- for p in site.pages -%}
          {%- if p.tags and p.tags contains tag -%}
            {%- if p.title and p.url -%}
              {%- assign pages_found = pages_found | plus: 1 -%}
              <li><a href="{{ p.url | relative_url }}">{{ p.title }}</a></li>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endcapture -%}

      {%- if pages_found > 0 -%}
        <div class="rf-tag-subhead">Pages</div>
        <ul class="rf-taglist">{{ pages_list }}</ul>
      {%- endif -%}

      {%- assign posts_found = 0 -%}
      {%- capture posts_list -%}
        {%- for post in site.posts -%}
          {%- if post.tags and post.tags contains tag -%}
            {%- if post.title and post.url -%}
              {%- assign posts_found = posts_found | plus: 1 -%}
              <li>
                <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
                <span class="rf-tagdate">{{ post.date | date: "%Y-%m-%d" }}</span>
              </li>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endcapture -%}

      {%- if posts_found > 0 -%}
        <div class="rf-tag-subhead">Posts</div>
        <ul class="rf-taglist">{{ posts_list }}</ul>
      {%- endif -%}
    </section>
  {%- endfor -%}
</div>
