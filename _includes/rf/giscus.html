{% if site.giscus and site.giscus.enabled %}
  <section class="rf-comments" aria-label="Comments">
    <div class="rf-card">
      <div class="rf-card-head">
        <div class="rf-kicker">Comments</div>
      </div>
      <div class="rf-card-body">
        <div class="giscus"></div>
      </div>
    </div>
  </section>

  {%- comment -%}
  Theme resolution rules:
  1) If site.giscus.theme is set, pass it through directly (supports:
     - built-in: "preferred_color_scheme"
     - custom: "https://.../theme.css"
     - custom pair: "https://.../light.css,https://.../dark.css"
     - custom relative: "/assets/giscus/aero2-light.css,/assets/giscus/aero2-dark.css"
  2) Else default to "preferred_color_scheme"
  {%- endcomment -%}

  {% assign giscus_theme = site.giscus.theme | default: "preferred_color_scheme" %}

  <script
    src="https://giscus.app/client.js"
    data-repo="{{ site.giscus.repo }}"
    data-repo-id="{{ site.giscus.repo_id }}"
    data-category="{{ site.giscus.category }}"
    data-category-id="{{ site.giscus.category_id }}"
    data-mapping="{{ site.giscus.mapping | default: 'pathname' }}"
    data-strict="0"
    data-reactions-enabled="{{ site.giscus.reactions_enabled | default: '1' }}"
    data-emit-metadata="{{ site.giscus.emit_metadata | default: '0' }}"
    data-input-position="{{ site.giscus.input_position | default: 'top' }}"
    data-theme="{{ giscus_theme }}"
    data-lang="{{ site.giscus.lang | default: 'en' }}"
    crossorigin="anonymous"
    async>
  </script>

  <script>
(() => {
  const configured = {{ giscus_theme | jsonify }};

  const looksLikeUrl = (s) => /^(https?:\/\/|\/)/.test(s) || s.includes(".css");
  if (!looksLikeUrl(configured)) return;

  // GitHub Pages project sites live under /REPO, so we must include baseurl.
  // This evaluates to "" locally (usually) and "/REPO" on GitHub Pages.
  const BASEURL = {{ site.baseurl | jsonify }} || "";

  const join = (a, b) => {
    const left = String(a || "").replace(/\/+$/, "");
    const right = String(b || "").replace(/^\/+/, "");
    return left ? `${left}/${right}` : `/${right}`;
  };

  const toAbs = (p) => {
    if (!p) return "";
    p = String(p).trim();

    // Already absolute
    if (/^https?:\/\//i.test(p)) return p;

    // Site-root path (e.g. "/assets/...") -> origin + baseurl + path
    if (p.startsWith("/")) return window.location.origin + join(BASEURL, p);

    // Relative path (e.g. "assets/..." or "./assets/...") -> origin + baseurl + "/" + path
    return window.location.origin + join(BASEURL, "/" + p.replace(/^\.?\//, ""));
  };

  const parts = String(configured).split(",").map(s => s.trim()).filter(Boolean);
  const light = toAbs(parts[0] || "");
  const dark  = toAbs(parts[1] || parts[0] || "");

  if (!light) return;

  const currentMode = () => {
    const v = (document.documentElement.dataset.theme || "").toLowerCase();
    return v === "dark" ? "dark" : "light";
  };

  const desiredThemeUrl = () => (currentMode() === "dark" ? (dark || light) : light);

  const postTheme = () => {
    const iframe = document.querySelector("iframe.giscus-frame");
    if (!iframe) return false;

    iframe.contentWindow.postMessage(
      { giscus: { setConfig: { theme: desiredThemeUrl() } } },
      "https://giscus.app"
    );
    return true;
  };

  let tries = 0;
  const tick = () => {
    if (postTheme()) return;
    if (++tries > 40) return;
    setTimeout(tick, 100);
  };
  tick();

  const mo = new MutationObserver(() => { postTheme(); });
  mo.observe(document.documentElement, { attributes: true, attributeFilter: ["data-theme"] });
})();
</script>
{% endif %}
