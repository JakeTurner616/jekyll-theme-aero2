{%- comment -%}
Uniform tag cloud across posts + pages (no plugins)
- On the tag page: clicking tag text toggles filtering (your JS)
- Everywhere else: chips link to the tag page anchor
{%- endcomment -%}

{%- comment -%}
Resolve the tag index page URL:
- Prefer a page with front matter: tagpage: 1
- Fallback: /tags/
{%- endcomment -%}
{%- assign _tagpage = site.pages | where_exp: "p", "p.tagpage == 1" | first -%}
{%- assign tags_page_url = _tagpage.url | default: "/tags/" -%}

{%- assign all_tags = "" -%}

{%- for post in site.posts -%}
  {%- if post.tags -%}
    {%- for t in post.tags -%}{%- assign all_tags = all_tags | append: t | append: "|" -%}{%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- for p in site.pages -%}
  {%- if p.tags -%}
    {%- for t in p.tags -%}{%- assign all_tags = all_tags | append: t | append: "|" -%}{%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- assign raw = all_tags | split: "|" -%}

{%- assign clean = "" -%}
{%- for t in raw -%}
  {%- assign s = t | strip -%}
  {%- if s != "" -%}{%- assign clean = clean | append: s | append: "|" -%}{%- endif -%}
{%- endfor -%}

{%- assign tags = clean | split: "|" -%}
{%- assign uniq = tags | sort | uniq -%}

{%- if uniq.size == 0 -%}
  <p class="rf-muted"><strong>No tags found.</strong> Add <code>tags:</code> to post/page front matter.</p>
{%- else -%}
  <div class="rf-tagcloud" role="navigation" aria-label="Tag cloud">
    {%- for tag in uniq -%}
      {%- assign c = 0 -%}
      {%- for t in tags -%}
        {%- if t == tag -%}{%- assign c = c | plus: 1 -%}{%- endif -%}
      {%- endfor -%}

      {%- assign slug = tag | downcase | strip
        | replace: " ", "-"
        | replace: ".", ""
        | replace: ",", ""
        | replace: "/", "-"
      -%}

      <a class="rf-tag rf-tagchip"
         href="{{ tags_page_url | relative_url }}#tag-{{ slug }}"
         data-tag="{{ tag | escape }}"
         data-slug="{{ slug | escape }}"
         aria-label="{{ tag }} ({{ c }})">
        <span class="rf-tag-text" role="button" tabindex="0">{{ tag }}</span>
        <span class="rf-tag-count">{{ c }}</span>
      </a>
    {%- endfor -%}
  </div>
{%- endif -%}
