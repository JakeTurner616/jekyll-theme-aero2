<!-- _layouts/default.html -->
<!doctype html>
<html lang="{{ page.lang | default: site.lang | default: 'en' }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  {% seo %}

  <!-- RF: no-flash theme boot -->
  <script>
  (() => {
    try {
      const KEY = "rf-theme"; // "system" | "light" | "dark"
      const saved = localStorage.getItem(KEY) || "system";
      const prefersDark = matchMedia("(prefers-color-scheme: dark)").matches;
      const resolved = saved === "system" ? (prefersDark ? "dark" : "light") : saved;

      document.documentElement.dataset.theme = resolved;
      document.documentElement.dataset.themePref = saved;
      document.documentElement.style.colorScheme = resolved;
    } catch (e) {}
  })();
  </script>

  <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
  {% include head-custom.html %}
</head>

<body class="rf">
  <div class="rf-bg">
    <div class="rf-shell">
      {% include rf/header.html %}


      <div class="rf-frame">
        <div class="rf-grid">
          <main class="rf-main" id="content">
            <article class="rf-article"
              {% if page.layout == "post" %}
                itemscope itemtype="https://schema.org/BlogPosting"
              {% endif %}
            >
              {% if page.title %}
                <header class="rf-posthead">
                  <h1 class="rf-h1" {% if page.layout == "post" %}itemprop="headline"{% endif %}>
                    {{ page.title }}
                  </h1>

                  {% if page.description %}
                    <p class="rf-description" {% if page.layout == "post" %}itemprop="description"{% endif %}>
                      {{ page.description }}
                    </p>
                  {% endif %}

                  {% if page.layout == "post" %}
                    <div class="rf-byline">
                      <time class="rf-date"
                            datetime="{{ page.date | date_to_xmlschema }}"
                            itemprop="datePublished">
                        {{ page.date | date: "%B %-d, %Y" }}
                      </time>

                      {% if page.author %}
                        <span class="rf-dot" aria-hidden="true">•</span>
                        {% assign author_label = page.author.name | default: page.author %}
                        {% assign author_url = page.author.url | default: site.author_url | default: "/contact/" %}
                        <a class="rf-author" href="{{ author_url | relative_url }}" itemprop="author">
                          {{ author_label }}
                        </a>
                      {% endif %}
                    </div>

                    <div class="rf-sep" aria-hidden="true"></div>
                  {% endif %}
                </header>
              {% endif %}

              <div class="rf-prose" {% if page.layout == "post" %}itemprop="articleBody"{% endif %}>
                {{ content }}
              </div>

              {% if page.layout == "post" and page.comments != false %}
                {% include rf/giscus.html %}
              {% endif %}
            </article>
          </main>

          <aside class="rf-side">
            {% if page.sidebar %}
              {{ page.sidebar }}
            {% else %}
              {% include rf/sidebar.html %}
            {% endif %}
          </aside>
        </div>
      </div>

      {% include rf/footer.html %}
      {% if page.math == true %}
        {% include rf/math.html %}
      {% endif %}
    </div>
  </div>

  <!-- Scripts: jQuery MUST load before aero2.js -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Magnific Popup -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.2.0/jquery.magnific-popup.min.js"></script>

  <script src="{{ '/assets/js/aero2.js' | relative_url }}"></script>

  <!-- RF: image lightbox gallery -->
  <script>
  (() => {
    const $ = window.jQuery;
    if (!$ || !$.fn || !$.fn.magnificPopup) return;

    const root = document.querySelector(".rf-prose");
    if (!root) return;

    const imgs = root.querySelectorAll("img.rf-media, .rf-prose img");
    imgs.forEach((img) => {
      if (!(img instanceof HTMLImageElement)) return;
      if (img.dataset.noLightbox === "1") return;

      const parent = img.parentElement;
      if (parent && parent.tagName === "A") return;
      if (!img.getAttribute("src")) return;

      const fig = img.closest("figure");
      const cap = fig ? fig.querySelector("figcaption") : null;
      const title = cap ? cap.textContent.trim() : (img.getAttribute("alt") || "").trim();

      const a = document.createElement("a");
      a.className = "rf-gallery";
      a.href = img.getAttribute("src");
      if (title) a.setAttribute("data-mfp-title", title);

      a.style.display = "inline-block";
      a.style.maxWidth = "100%";

      img.parentNode.insertBefore(a, img);
      a.appendChild(img);
    });

    $(".rf-prose").magnificPopup({
      delegate: "a.rf-gallery",
      type: "image",
      closeOnContentClick: false,
      closeBtnInside: true,
      fixedContentPos: true,
      mainClass: "mfp-fade",
      image: {
        titleSrc: function(item) {
          const t = item.el && item.el.attr("data-mfp-title");
          return t ? t : "";
        }
      }
    });
  })();
  </script>

  <!-- RF: tag filtering (your existing script; unchanged) -->
  <script>
(() => {
  const $ = window.jQuery;
  if (!$) return;

  const $page = $(".rf-tagpage[data-tagpage='1']");
  if (!$page.length) return;

  const $chips = $page.find(".rf-tagchip");
  const $groups = $page.find(".rf-taggroup");

  function slugOfChip($chip) {
    return String($chip.data("slug") || "");
  }

  function setActiveBySlug(slug) {
    if (!slug) {
      $groups.show();
      $chips.removeClass("is-active");
      return;
    }

    let found = false;

    $groups.each(function () {
      const s = String($(this).data("slug") || "");
      const show = s === slug;
      $(this).toggle(show);
      if (show) found = true;
    });

    $chips.each(function () {
      const s = slugOfChip($(this));
      $(this).toggleClass("is-active", s === slug);
    });

    if (found) {
      const el = document.getElementById(`tag-${slug}`);
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }

  function readRoute() {
    const h = (window.location.hash || "").trim();
    if (!h || h === "#" || h === "#/all") return { mode: "all", slug: "" };
    if (h.startsWith("#tag-")) return { mode: "tag", slug: h.slice("#tag-".length) };
    if (h.startsWith("#/tag/")) return { mode: "tag", slug: decodeURIComponent(h.slice("#/tag/".length)) };
    return { mode: "all", slug: "" };
  }

  function writeRouteTag(slug) {
    const next = slug ? `#/tag/${encodeURIComponent(slug)}` : "#/all";
    if (window.location.hash !== next) window.location.hash = next;
  }

  function applyFromHash() {
    const r = readRoute();
    setActiveBySlug(r.mode === "tag" ? r.slug : "");
  }

  $page.on("click", ".rf-tagchip .rf-tag-text", function (e) {
    e.preventDefault();
    e.stopPropagation();

    const $chip = $(this).closest(".rf-tagchip");
    const slug = slugOfChip($chip);

    const r = readRoute();
    const isAlready = (r.mode === "tag" && r.slug === slug);

    writeRouteTag(isAlready ? "" : slug);
  });

  $page.on("keydown", ".rf-tagchip .rf-tag-text", function (e) {
    if (e.key !== "Enter" && e.key !== " ") return;
    e.preventDefault();
    e.stopPropagation();

    const $chip = $(this).closest(".rf-tagchip");
    const slug = slugOfChip($chip);

    const r = readRoute();
    const isAlready = (r.mode === "tag" && r.slug === slug);

    writeRouteTag(isAlready ? "" : slug);
  });

  $page.on("click", ".rf-tagchip", function (e) {
    if ($(e.target).closest(".rf-tag-text").length) return;
    const slug = slugOfChip($(this));
    if (slug) writeRouteTag(slug);
  });

  window.addEventListener("hashchange", applyFromHash);
  applyFromHash();
})();
  </script>

  <!-- RF: theme toggle behavior -->
  <script>
(() => {
  const KEY = "rf-theme"; // "system" | "light" | "dark"
  const btn = document.querySelector("[data-rf-theme-toggle]");
  if (!btn) return;

  const ico = btn.querySelector(".rf-theme-ico");
  const txt = btn.querySelector(".rf-theme-txt");

  const prefersDarkMQ = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;

  const resolve = (pref) => {
    if (pref !== "system") return pref;
    const prefersDark = !!(prefersDarkMQ && prefersDarkMQ.matches);
    return prefersDark ? "dark" : "light";
  };

  const apply = (pref) => {
    const theme = resolve(pref);
    document.documentElement.dataset.theme = theme;
    document.documentElement.dataset.themePref = pref;
    document.documentElement.style.colorScheme = theme;

    if (ico) ico.textContent = pref === "system" ? "◐" : (theme === "dark" ? "☾" : "☀");
    if (txt) txt.textContent = pref[0].toUpperCase() + pref.slice(1);

    try { localStorage.setItem(KEY, pref); } catch (e) {}
  };

  const nextPref = (pref) => (pref === "system" ? "dark" : pref === "dark" ? "light" : "system");

  const saved = (localStorage.getItem(KEY) || document.documentElement.dataset.themePref || "system");
  apply(saved);

  btn.addEventListener("click", () => {
    const current = document.documentElement.dataset.themePref || "system";
    apply(nextPref(current));
  });

  if (prefersDarkMQ) {
    prefersDarkMQ.addEventListener("change", () => {
      const pref = document.documentElement.dataset.themePref || "system";
      if (pref === "system") apply("system");
    });
  }
})();
  </script>

</body>
</html>
